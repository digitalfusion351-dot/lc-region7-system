<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>LC Region 7 – Admin Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0d47a1" />

  <!-- ฟอนต์ & ไอคอน -->
  <link
    href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
    rel="stylesheet"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #0d47a1;
      --primary-strong: #1565c0;
      --primary-soft: #e3f2fd;
      --bg: #f3f6fb;
      --sidebar-width: 260px;
      --radius-xl: 18px;
      --radius-lg: 14px;
      --shadow-soft: 0 12px 32px rgba(15, 23, 42, 0.12);
      --shadow-hard: 0 16px 45px rgba(13, 71, 161, 0.18);
      --text-main: #1f2933;
      --text-soft: #6b7280;
      --accent-green: #1bcfb4;
      --accent-yellow: #f6c453;
      --accent-red: #ef5350;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Kanit", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #eaf2ff, #f9fbff);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 15% 20%, rgba(21, 101, 192, 0.12), transparent 38%),
                  radial-gradient(circle at 85% 15%, rgba(24, 194, 128, 0.12), transparent 35%),
                  radial-gradient(circle at 60% 80%, rgba(255, 193, 7, 0.12), transparent 32%);
      z-index: 0;
      pointer-events: none;
    }

    .app {
      display: flex;
      width: 100%;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, #0d47a1, #1565c0);
      color: #e3f2fd;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: sticky;
      top: 0;
      height: 100vh;
      transition: transform 0.25s ease;
      z-index: 20;
      box-shadow: var(--shadow-hard);
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(13, 71, 161, 0.28);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .sidebar-logo {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, #ffffff, #b3d8ff);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0d47a1;
      font-weight: 700;
      box-shadow: 0 4px 14px rgba(0,0,0,0.18);
      letter-spacing: 0.5px;
    }

    .sidebar-title {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .sidebar-title span:first-child {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .sidebar-title span:last-child {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .sidebar-nav {
      list-style: none;
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nav-item {
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 0.88rem;
      color: #e3f2fd;
      opacity: 0.9;
      transition: background 0.2s ease, transform 0.1s ease, opacity 0.2s ease;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: rgba(13, 71, 161, 0.55);
      transform: translateY(-1px);
      opacity: 1;
      border-color: rgba(255,255,255,0.15);
    }

    .nav-item.active {
      background: #ffffff;
      color: #0d47a1;
      opacity: 1;
      box-shadow: 0 10px 24px rgba(13, 71, 161, 0.24);
    }

    .nav-item .material-symbols-outlined {
      font-size: 20px;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 0.75rem;
      opacity: 0.75;
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 18px 22px;
      gap: 18px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(13, 71, 161, 0.08);
      border-radius: 16px;
      box-shadow: var(--shadow-soft);
      padding: 14px 16px;
      backdrop-filter: blur(6px);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: none;
      background: #ffffff;
      box-shadow: var(--shadow-soft);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--primary);
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    .btn-icon:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-hard);
    }

    .topbar-title {
      display: flex;
      flex-direction: column;
    }

    .topbar-title h1 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .topbar-title span {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .topbar-right {
      font-size: 0.8rem;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip-admin {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 0.78rem;
      border: 1px solid rgba(13, 71, 161, 0.12);
    }

    .chip-admin .material-symbols-outlined {
      font-size: 16px;
    }

    /* Content layout */
    .content {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .hero {
      display: grid;
      grid-template-columns: 2.2fr 1fr;
      gap: 14px;
      align-items: center;
    }

    .hero-card {
      background: linear-gradient(120deg, rgba(13, 71, 161, 0.9), #1976d2);
      color: #e3f2fd;
      border-radius: 18px;
      padding: 16px 18px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 16px 42px rgba(13, 71, 161, 0.2);
    }

    .hero-card::after {
      content: "";
      position: absolute;
      width: 240px;
      height: 240px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.08);
      top: -60px;
      right: -60px;
      filter: blur(2px);
    }

    .hero-card h1 {
      font-size: 1.25rem;
      margin-bottom: 4px;
    }

    .hero-card p {
      color: rgba(227, 242, 253, 0.9);
      font-size: 0.88rem;
    }

    .hero-highlights {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .hero-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.22);
      font-size: 0.78rem;
    }

    .hero-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mini-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(13, 71, 161, 0.08);
    }

    .mini-card h3 {
      font-size: 0.92rem;
      margin-bottom: 6px;
    }

    .mini-list {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 0.78rem;
      background: #f1f5f9;
      color: #334155;
    }

    @media (max-width: 1100px) {
      .grid-4 { grid-column: span 6; }
      .grid-6 { grid-column: span 12; }
      .grid-8 { grid-column: span 12; }
      .hero { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      :root { --sidebar-width: 230px; }
      .sidebar { position: fixed; height: 100%; }
      .main { padding: 14px; }
      .topbar { flex-direction: column; align-items: flex-start; }
      .topbar-right { width: 100%; justify-content: flex-start; flex-wrap: wrap; }
      .grid { grid-template-columns: repeat(12, 1fr); }
      .grid-4, .grid-6, .grid-8 { grid-column: span 12; }
    }

    .card {
      background: #ffffff;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px;
      border: 1px solid rgba(13, 71, 161, 0.06);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(21,101,192,0.08), transparent 40%);
      opacity: 0.5;
      pointer-events: none;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-header h2 {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .card-header span {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
    }

    .grid-4 {
      grid-column: span 4;
    }

    .grid-6 {
      grid-column: span 6;
    }

    .grid-8 {
      grid-column: span 8;
    }

    .summary-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, #e3f2fd, #ffffff);
      border: 1px solid rgba(21, 101, 192, 0.12);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
    }

    .summary-info h3 {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .summary-info strong {
      font-size: 1.25rem;
    }

    .summary-chip {
      font-size: 0.7rem;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(21, 101, 192, 0.08);
      color: var(--primary);
      margin-top: 2px;
      display: inline-block;
    }

    .summary-icon {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0d47a1;
      background: #ffffff;
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.14);
    }

    .summary-icon .material-symbols-outlined {
      font-size: 20px;
    }

    .status-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .status-pill {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 4px 8px;
      background: #f3f4f6;
      color: #4b5563;
    }

    .status-pill.received { border-left: 3px solid var(--primary); }
    .status-pill.inprogress { border-left: 3px solid var(--accent-yellow); }
    .status-pill.waiting { border-left: 3px solid #9ca3af; }
    .status-pill.closed { border-left: 3px solid var(--accent-green); }
    .status-pill.rejected { border-left: 3px solid var(--accent-red); }

    .chart-container {
      position: relative;
      width: 100%;
      max-width: 480px;
      margin: 2px auto 0;
    }

    canvas {
      max-height: 230px;
    }

    /* Table */
    .table-container {
      margin-top: 4px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid #e5e7eb;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      background: linear-gradient(90deg, #eef2ff, #f3f6ff);
      position: sticky;
      top: 0;
      z-index: 1;
      box-shadow: inset 0 -1px 0 #e5e7eb;
    }

    th, td {
      padding: 9px 10px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }

    tr:hover td {
      background: #f9fafb;
    }

    th {
      font-weight: 500;
      color: #4b5563;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      gap: 3px;
    }

    .status-badge.received {
      background: #e3f2fd;
      color: var(--primary);
    }

    .status-badge.inprogress {
      background: #fff7e0;
      color: #b45309;
    }

    .status-badge.waiting {
      background: #e5e7eb;
      color: #4b5563;
    }

    .status-badge.closed {
      background: #dcfce7;
      color: #15803d;
    }

    .status-badge.rejected {
      background: #fee2e2;
      color: #b91c1c;
    }

    .alert {
      border-radius: var(--radius-lg);
      padding: 8px 10px;
      font-size: 0.78rem;
      line-height: 1.4;
      border: 1px solid #f3f4f6;
      background: #f8fafc;
      color: #1f2933;
      display: none;
    }

    .alert.error {
      border-left: 4px solid var(--accent-red);
      background: #fef2f2;
      color: #991b1b;
    }

    .btn-table {
      border-radius: 999px;
      border: none;
      padding: 3px 8px;
      font-size: 0.7rem;
      cursor: pointer;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .btn-table.secondary {
      background: #f3f4f6;
      color: #4b5563;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }

    select, input, textarea {
      font-family: inherit;
      font-size: 0.8rem;
    }

    .select, .input {
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      min-width: 130px;
    }

    .btn-primary {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      background: linear-gradient(135deg, #1565c0, #1e88e5);
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-primary .material-symbols-outlined {
      font-size: 16px;
    }

    .badge-soft {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 7px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 0.7rem;
      color: #4b5563;
    }

    /* API Tester */
    .api-form {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      margin-bottom: 10px;
      font-size: 0.8rem;
    }

    .api-form .col-3 { grid-column: span 3; }
    .api-form .col-4 { grid-column: span 4; }
    .api-form .col-6 { grid-column: span 6; }
    .api-form .col-12 { grid-column: span 12; }

    textarea.api-body {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      padding: 8px;
      resize: vertical;
      min-height: 80px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
    }

    pre.api-response {
      background: #020617;
      color: #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      font-size: 0.75rem;
      overflow-x: auto;
      max-height: 260px;
    }

    /* Views */
    .view {
      display: none;
      gap: 14px;
    }
    .view.active {
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 900px) {
      .sidebar {
        position: fixed;
        left: 0;
      }
      .grid-4, .grid-6, .grid-8 { grid-column: span 12; }
      .api-form .col-3,
      .api-form .col-4,
      .api-form .col-6 { grid-column: span 12; }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">LC</div>
      <div class="sidebar-title">
        <span>สภาทนายความภาค 7</span>
        <span>Administration Console</span>
      </div>
    </div>

    <ul class="sidebar-nav">
      <li class="nav-item active" data-view="dashboard">
        <span class="material-symbols-outlined">dashboard</span>
        <span>แดชบอร์ดภาพรวม</span>
      </li>
      <li class="nav-item" data-view="cases">
        <span class="material-symbols-outlined">folder_managed</span>
        <span>จัดการคำร้องทุกประเภท</span>
      </li>
      <li class="nav-item" data-view="api-test">
        <span class="material-symbols-outlined">api</span>
        <span>ทดสอบ API</span>
      </li>
      <!-- เผื่อใช้ในอนาคต: สมาชิกแอดมิน -->
      <!--
      <li class="nav-item" data-view="members">
        <span class="material-symbols-outlined">group</span>
        <span>จัดการสมาชิกแอดมิน</span>
      </li>
      -->
    </ul>

    <div class="sidebar-footer">
      <div>LC Region 7 • Backend: Apps Script</div>
      <div style="margin-top:4px; font-size:0.72rem; opacity:0.85;">
        PWA-ready • Netlify Static Hosting
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <!-- Topbar -->
    <div class="topbar">
      <div class="topbar-left">
        <button class="btn-icon" id="btnToggleSidebar" title="ซ่อน/แสดงเมนู">
          <span class="material-symbols-outlined">menu</span>
        </button>
        <div class="topbar-title">
          <h1>ศูนย์บริหารจัดการคำร้อง – แอดมิน</h1>
          <span>ดูสถานะ, อนุมัติ/ปฏิเสธคำร้อง และตรวจสอบ API</span>
        </div>
      </div>
      <div class="topbar-right">
        <span class="badge-soft">
          <span class="material-symbols-outlined">key</span>
          ADMIN KEY: LC7-Admin-2025
        </span>
        <span class="chip-admin">
          <span class="material-symbols-outlined">shield_person</span>
          Admin Region 7
        </span>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="hero">
        <div class="hero-card">
          <h1>จัดการคำร้องภาค 7 ได้อย่างเป็นระบบ</h1>
          <p>
            ภาพรวมคำร้องทุกช่องทาง พร้อมเครื่องมืออัปเดตสถานะและทดสอบ API ในที่เดียว
          </p>
          <div class="hero-highlights">
            <div class="hero-chip">
              <span class="material-symbols-outlined">verified</span>
              Secure Admin
            </div>
            <div class="hero-chip">
              <span class="material-symbols-outlined">dashboard</span>
              Real-time Summary
            </div>
            <div class="hero-chip">
              <span class="material-symbols-outlined">dns</span>
              Apps Script Backend
            </div>
          </div>
        </div>

        <div class="hero-actions">
          <div class="mini-card">
            <h3>จุดเด่น</h3>
            <div class="mini-list">
              <span class="pill"><span class="material-symbols-outlined">insights</span>แผนภูมิภาพรวม</span>
              <span class="pill"><span class="material-symbols-outlined">fact_check</span>อัปเดตสถานะรวดเร็ว</span>
              <span class="pill"><span class="material-symbols-outlined">terminal</span>API Playground</span>
            </div>
          </div>
          <div class="mini-card">
            <h3>แนวทางใช้งาน</h3>
            <div class="mini-list">
              <span class="pill">1) ตรวจสอบแดชบอร์ด</span>
              <span class="pill">2) เลือกคำร้องและอัปเดตสถานะ</span>
              <span class="pill">3) ทดสอบ API หรืออัปเดตเพิ่มเติม</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard View -->
      <section class="view active" id="view-dashboard">
        <div class="grid">
          <!-- Summary cards -->
          <div class="grid-4">
            <div class="card">
              <div class="card-header">
                <h2>ภาพรวมคำร้องวันนี้</h2>
                <span id="summary-date"></span>
              </div>
              <div class="alert error" id="summary-alert"></div>
              <div class="grid" style="grid-template-columns: repeat(12,1fr); gap:8px;">
                <div class="summary-card" style="grid-column: span 12;">
                  <div class="summary-info">
                    <h3>คำร้องทั้งหมด</h3>
                    <strong id="total-cases">0</strong>
                    <div class="summary-chip">รวมทุกประเภท (ประชาชน + ทนาย)</div>
                  </div>
                  <div class="summary-icon" style="background:#e8f5e9;color:#1b5e20;">
                    <span class="material-symbols-outlined">analytics</span>
                  </div>
                </div>
                <div class="summary-card" style="grid-column: span 6;">
                  <div class="summary-info">
                    <h3>คำร้องจากประชาชน</h3>
                    <strong id="citizen-total">0</strong>
                    <div class="summary-chip">ช่องทางประชาชนทั่วไป</div>
                  </div>
                  <div class="summary-icon" style="background:#e3f2fd;">
                    <span class="material-symbols-outlined">account_circle</span>
                  </div>
                </div>
                <div class="summary-card" style="grid-column: span 6;">
                  <div class="summary-info">
                    <h3>คำขอช่วยเหลือจากทนาย</h3>
                    <strong id="lawyer-total">0</strong>
                    <div class="summary-chip">ทนายความขอความช่วยเหลือ</div>
                  </div>
                  <div class="summary-icon" style="background:#fff3e0;color:#ef6c00;">
                    <span class="material-symbols-outlined">gavel</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pie chart: status -->
          <div class="grid-4">
            <div class="card">
              <div class="card-header">
                <h2>สัดส่วนสถานะคำร้อง</h2>
                <span>RECEIVED / IN PROGRESS / CLOSED ฯลฯ</span>
              </div>
              <div class="chart-container">
                <canvas id="statusPieChart"></canvas>
              </div>
              <div class="status-pills" id="status-pill-list" style="margin-top:8px;"></div>
            </div>
          </div>

          <!-- Bar chart: citizen vs lawyer -->
          <div class="grid-4">
            <div class="card">
              <div class="card-header">
                <h2>เปรียบเทียบประเภทคำร้อง</h2>
                <span>ประชาชน vs ทนายความ</span>
              </div>
              <div class="chart-container">
                <canvas id="typeBarChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Cases View -->
      <section class="view" id="view-cases">
        <div class="card">
          <div class="card-header">
            <h2>จัดการคำร้องทั้งหมด</h2>
            <span>เปลี่ยนสถานะ, ตรวจสอบรายละเอียดเบื้องต้น</span>
          </div>

          <div class="filter-row">
            <select class="select" id="filter-module">
              <option value="citizen">คำร้องจากประชาชน</option>
              <option value="lawyer">คำขอช่วยเหลือจากทนาย</option>
            </select>
            <select class="select" id="filter-status">
              <option value="ALL">ทุกสถานะ</option>
              <option value="RECEIVED">รับเรื่องแล้ว</option>
              <option value="IN_PROGRESS">กำลังดำเนินการ</option>
              <option value="WAITING">รอข้อมูลเพิ่มเติม</option>
              <option value="CLOSED">ปิดเรื่องแล้ว</option>
              <option value="REJECTED">ไม่รับดำเนินการ</option>
            </select>
            <button class="btn-primary" id="btnRefreshCases">
              <span class="material-symbols-outlined">refresh</span>
              โหลดรายการ
            </button>
            <span style="margin-left:auto;font-size:0.75rem;color:var(--text-soft);">
              คลิกปุ่ม "อัปเดตสถานะ" ในแถวที่ต้องการ
            </span>
          </div>

          <div class="alert error" id="cases-alert"></div>

          <div class="table-container">
            <table>
              <thead>
              <tr>
                <th>เลขอ้างอิง</th>
                <th>ชื่อผู้ยื่น</th>
                <th>ประเภทเรื่อง</th>
                <th>สถานะ</th>
                <th>สร้างเมื่อ</th>
                <th>อัปเดตล่าสุด</th>
                <th style="width:140px;">จัดการ</th>
              </tr>
              </thead>
              <tbody id="cases-table-body">
              <tr><td colspan="7" style="text-align:center;color:#9ca3af;padding:12px;">ยังไม่มีข้อมูล</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- API Test View -->
      <section class="view" id="view-api-test">
        <div class="card">
          <div class="card-header">
            <h2>ทดสอบ API (สำหรับแอดมิน)</h2>
            <span>ยิง GET / POST ไปยัง Apps Script แล้วดูผลลัพธ์ JSON</span>
          </div>

          <div class="api-form">
            <div class="col-3">
              <label style="font-size:0.78rem;">Method</label><br/>
              <select class="select" id="api-method">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
              </select>
            </div>

            <div class="col-4">
              <label style="font-size:0.78rem;">Action (เช่น adminSummary, adminListCases, ping)</label><br/>
              <input class="input" id="api-action" value="adminSummary" />
            </div>

            <div class="col-5">
              <label style="font-size:0.78rem;">พารามิเตอร์เพิ่มเติม (รูปแบบ key=value&key2=value2)</label><br/>
              <input class="input" id="api-params"
                     value="admin_key=LC7-Admin-2025" />
            </div>

            <div class="col-12">
              <label style="font-size:0.78rem;">ข้อมูลใน body (สำหรับ POST เท่านั้น – รูปแบบ key=value&...)</label><br/>
              <textarea class="api-body" id="api-body"></textarea>
            </div>

            <div class="col-12" style="display:flex;gap:8px;align-items:center;">
              <button class="btn-primary" id="btnSendApi">
                <span class="material-symbols-outlined">play_arrow</span>
                ส่งคำขอทดสอบ
              </button>
              <span style="font-size:0.75rem;color:var(--text-soft);">
                ระบบจะส่งไปที่ URL ฐานของ Apps Script ของคุณและแสดง JSON ด้านล่าง
              </span>
            </div>
          </div>

          <pre class="api-response" id="api-response">// รอผลลัพธ์จาก API...</pre>
        </div>
      </section>

      <!-- สมาชิก/แอดมิน (เผื่ออนาคต) -->
      <section class="view" id="view-members" style="display:none;">
        <div class="card">
          <div class="card-header">
            <h2>จัดการสมาชิกแอดมิน</h2>
            <span>ส่วนนี้สำหรับอนาคต หากจะผูกกับชีต ADMIN_MEMBER</span>
          </div>
          <p style="font-size:0.85rem;color:var(--text-soft);">
            โครงนี้เตรียมไว้แล้ว หากต้องการให้ช่วยต่อยอดระบบสมาชิกแอดมิน (เพิ่ม/ลบ/แก้ไข username, password) 
            สามารถบอกได้เลย จะเชื่อมกับชีต ADMIN_MEMBER ในไฟล์เดียวกับคำร้อง
          </p>
        </div>
      </section>
    </div>
  </main>
</div>

<script>
  // ========================
  // CONFIG – แก้ตรงนี้หากเปลี่ยนลิงก์ Apps Script
  // ========================
  const BASE_API_URL = "https://script.google.com/macros/s/AKfycbzwC16nHF1P950tsITwRc8e2EfKmCYMN-QHekY2D0nbn6bwSev6HfnnsB2VUGTtD7yrAA/exec";
  const ADMIN_KEY    = "LC7-Admin-2025";

  // ========================
  // Sidebar toggle & view switching
  // ========================
  const sidebar = document.getElementById("sidebar");
  const btnToggleSidebar = document.getElementById("btnToggleSidebar");
  const navItems = document.querySelectorAll(".nav-item");
  const summaryAlert = document.getElementById("summary-alert");
  const casesAlert = document.getElementById("cases-alert");
  const views = {
    dashboard: document.getElementById("view-dashboard"),
    cases: document.getElementById("view-cases"),
    "api-test": document.getElementById("view-api-test"),
    members: document.getElementById("view-members")
  };

  function showAlert(el, message) {
    if (!el) return;
    if (message) {
      el.textContent = message;
      el.style.display = "block";
    } else {
      el.textContent = "";
      el.style.display = "none";
    }
  }

  async function fetchJsonStrict(url, options) {
    const res = await fetch(url, options);
    const text = await res.text();
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${text.slice(0, 120)}`);
    }
    try {
      return JSON.parse(text);
    } catch (err) {
      throw new Error("Invalid JSON response");
    }
  }

  btnToggleSidebar.addEventListener("click", () => {
    sidebar.classList.toggle("collapsed");
  });

  navItems.forEach(item => {
    item.addEventListener("click", () => {
      navItems.forEach(i => i.classList.remove("active"));
      item.classList.add("active");

      const viewKey = item.dataset.view;
      Object.keys(views).forEach(k => {
        views[k].classList.remove("active");
      });
      const viewElement = views[viewKey === "api-test" ? "api-test" : viewKey];
      if (viewElement) viewElement.classList.add("active");
    });
  });

  // ========================
  // Dashboard – Summary + Charts
  // ========================
  let statusPieChart, typeBarChart;

  async function fetchAdminSummary() {
    const url = `${BASE_API_URL}?action=adminSummary&admin_key=${encodeURIComponent(ADMIN_KEY)}`;
    showAlert(summaryAlert, "");
    try {
      const data = await fetchJsonStrict(url);
      updateSummaryUI(data);
      updateCharts(data);
    } catch (err) {
      console.error(err);
      updateSummaryUI({});
      showAlert(summaryAlert, `ไม่สามารถโหลดข้อมูลสรุปได้: ${err.message}`);
    }
  }

  function updateSummaryUI(summary) {
    const dateSpan = document.getElementById("summary-date");
    const now = new Date();
    dateSpan.textContent = now.toLocaleString("th-TH", {
      dateStyle: "medium",
      timeStyle: "short"
    });

    document.getElementById("total-cases").textContent = summary.total || 0;
    document.getElementById("citizen-total").textContent = summary.citizen_total || 0;
    document.getElementById("lawyer-total").textContent = summary.lawyer_total || 0;
  }

  function updateCharts(summary) {
    const statusAll = summary.status_all || {};
    const labels = ["RECEIVED", "IN_PROGRESS", "WAITING", "CLOSED", "REJECTED"];
    const values = labels.map(k => statusAll[k] || 0);

    const ctxPie = document.getElementById("statusPieChart").getContext("2d");
    const ctxBar = document.getElementById("typeBarChart").getContext("2d");

    if (statusPieChart) statusPieChart.destroy();
    if (typeBarChart) typeBarChart.destroy();

    statusPieChart = new Chart(ctxPie, {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: [
            "#42a5f5",
            "#f6c453",
            "#9ca3af",
            "#66bb6a",
            "#ef5350"
          ],
          borderWidth: 0
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        cutout: "60%"
      }
    });

    const pillList = document.getElementById("status-pill-list");
    pillList.innerHTML = "";
    labels.forEach((label, idx) => {
      const count = values[idx];
      const pill = document.createElement("div");
      pill.className = "status-pill " + labelToClass(label);
      pill.textContent = `${label} (${count})`;
      pillList.appendChild(pill);
    });

    typeBarChart = new Chart(ctxBar, {
      type: "bar",
      data: {
        labels: ["Citizen", "Lawyer"],
        datasets: [{
          label: "จำนวนคำร้อง",
          data: [summary.citizen_total || 0, summary.lawyer_total || 0],
          backgroundColor: ["#42a5f5", "#7e57c2"],
          borderRadius: 6,
          maxBarThickness: 40
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
      }
    });
  }

  function labelToClass(label) {
    switch (label) {
      case "RECEIVED": return "received";
      case "IN_PROGRESS": return "inprogress";
      case "WAITING": return "waiting";
      case "CLOSED": return "closed";
      case "REJECTED": return "rejected";
      default: return "";
    }
  }

  // ========================
  // Cases list
  // ========================
  const filterModule = document.getElementById("filter-module");
  const filterStatus = document.getElementById("filter-status");
  const btnRefreshCases = document.getElementById("btnRefreshCases");
  const tableBody = document.getElementById("cases-table-body");

  btnRefreshCases.addEventListener("click", loadCases);
  filterModule.addEventListener("change", loadCases);
  filterStatus.addEventListener("change", loadCases);

  async function loadCases() {
    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:10px;color:#9ca3af;">กำลังโหลดข้อมูล...</td></tr>`;
    const module = filterModule.value;
    const status = filterStatus.value;

    showAlert(casesAlert, "");

    const params = new URLSearchParams({
      action: "adminListCases",
      module,
      status,
      admin_key: ADMIN_KEY
    });

    let data;
    try {
      data = await fetchJsonStrict(`${BASE_API_URL}?${params.toString()}`);
    } catch (err) {
      console.error(err);
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:10px;color:#9ca3af;">โหลดข้อมูลล้มเหลว: ${escapeHtml(err.message)}</td></tr>`;
      showAlert(casesAlert, `โหลดรายการไม่สำเร็จ: ${err.message}`);
      return;
    }

    const items = data.items || [];
    if (!items.length) {
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:10px;color:#9ca3af;">ไม่พบข้อมูล</td></tr>`;
      return;
    }

    tableBody.innerHTML = "";
    items.forEach(item => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${item.reference_no || "-"}</td>
        <td>${escapeHtml(item.name || "-")}</td>
        <td>${escapeHtml(item.type || "-")}</td>
        <td>${renderStatusBadge(item.status || "")}</td>
        <td>${item.created_at || ""}</td>
        <td>${item.last_update || ""}</td>
        <td>
          <button class="btn-table" data-ref="${item.reference_no}" data-module="${module}">อัปเดตสถานะ</button>
        </td>
      `;

      tableBody.appendChild(tr);
    });

    tableBody.querySelectorAll(".btn-table").forEach(btn => {
      btn.addEventListener("click", () => openUpdateStatusPrompt(btn.dataset.module, btn.dataset.ref));
    });
  }

  function renderStatusBadge(status) {
    const cls = "status-badge " + labelToClass(status);
    let th = status;
    switch (status) {
      case "RECEIVED": th = "รับเรื่องแล้ว"; break;
      case "IN_PROGRESS": th = "กำลังดำเนินการ"; break;
      case "WAITING": th = "รอข้อมูลเพิ่มเติม"; break;
      case "CLOSED": th = "ปิดเรื่องแล้ว"; break;
      case "REJECTED": th = "ไม่รับดำเนินการ"; break;
    }
    return `<span class="${cls}">${th}</span>`;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    })[s]);
  }

  async function openUpdateStatusPrompt(module, ref) {
    const status = prompt(
      `ระบุสถานะใหม่สำหรับ ${ref}\n\nRECEIVED, IN_PROGRESS, WAITING, CLOSED, REJECTED`,
      "IN_PROGRESS"
    );
    if (!status) return;
    const note = prompt("หมายเหตุ/บันทึก (ถ้ามี)", "");

    const params = new URLSearchParams();
    params.set("action", "adminUpdateStatus");
    params.set("admin_key", ADMIN_KEY);
    params.set("module", module);
    params.set("reference_no", ref);
    params.set("status", status.toUpperCase());
    if (note) params.set("admin_note", note);

    try {
      const data = await fetchJsonStrict(BASE_API_URL, {
        method: "POST",
        body: params
      });

      if (data.ok) {
        alert("อัปเดตสถานะเรียบร้อยแล้ว");
        await fetchAdminSummary();
        await loadCases();
      } else {
        alert("เกิดข้อผิดพลาด: " + JSON.stringify(data));
      }
    } catch (err) {
      alert("เกิดข้อผิดพลาดในการเชื่อมต่อ: " + err.message);
    }
  }

  // ========================
  // API Tester
  // ========================
  const apiMethodEl = document.getElementById("api-method");
  const apiActionEl = document.getElementById("api-action");
  const apiParamsEl = document.getElementById("api-params");
  const apiBodyEl = document.getElementById("api-body");
  const apiResponseEl = document.getElementById("api-response");
  const btnSendApi = document.getElementById("btnSendApi");

  btnSendApi.addEventListener("click", async () => {
    const method = apiMethodEl.value;
    const action = apiActionEl.value.trim();
    const extraParams = apiParamsEl.value.trim();
    const bodyRaw = apiBodyEl.value.trim();

    const params = new URLSearchParams(extraParams);
    if (action) params.set("action", action);

    let url = BASE_API_URL;
    let fetchOptions = { method };

    if (method === "GET") {
      url = `${BASE_API_URL}?${params.toString()}`;
    } else {
      const bodyParams = new URLSearchParams(bodyRaw || "");
      // รวม action + params ใน body
      for (const [k, v] of params.entries()) {
        bodyParams.set(k, v);
      }
      fetchOptions.body = bodyParams;
    }

    apiResponseEl.textContent = "// กำลังส่งคำขอ...\n" + url;

    try {
      const res = await fetch(url, fetchOptions);
      const text = await res.text();
      try {
        const json = JSON.parse(text);
        apiResponseEl.textContent = JSON.stringify(json, null, 2);
      } catch {
        apiResponseEl.textContent = text;
      }
    } catch (err) {
      apiResponseEl.textContent = "Error: " + err.toString();
    }
  });

  // ========================
  // Initial load
  // ========================
  (async () => {
    try {
      await fetchAdminSummary();
      await loadCases();
    } catch (err) {
      console.error(err);
    }
  })();

  // (Optional) PWA – ถ้าคุณมี sw.js ค่อยเปิดใช้
  /*
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js").catch(console.error);
  }
  */
</script>
</body>
</html>
